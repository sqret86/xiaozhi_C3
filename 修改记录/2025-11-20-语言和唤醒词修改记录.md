## 小智固件修改记录 – 2025-11-20

### 一、唤醒词检测优化

- **涉及文件**：`main/audio/wake_words/esp_wake_word.h`、`main/audio/wake_words/esp_wake_word.cc`
- **修改要点**：
  - 将 WakeNet 创建模式调整为 `DET_MODE_90`（Normal），相对原先的更高灵敏度模式，**略微降低灵敏度**，在保证可唤醒的前提下减少待机时的噪声误触。
  - 在 `EspWakeWord::Feed()` 中增加 **冷却时间控制**：
    - 使用 `last_trigger_time_us_` 记录上次成功触发唤醒的时间；
    - 设置 `kMinTriggerIntervalMs_ = 2000`，两次唤醒之间至少间隔 2 秒，避免短时间连续误触。
  - 保持 **单帧检测触发策略**，不再叠加多帧连续计数逻辑，将复杂度交给 WakeNet 内部的 DET_MODE 判定。
  - 启动时打印当前加载的唤醒词模型名称、采样率、chunk 大小及可用唤醒词字符串，便于串口调试和确认实际唤醒词。

### 二、动态语言切换（GeoIP + 运行时语言环境）

- **涉及文件**：`main/language_runtime.h`、`main/language_runtime.cc`、`main/boards/common/wifi_board.cc`
- **修改要点**：
  - 新增 `LanguageRuntime` 工具：
    - `IsZhCN()`：根据 NVS 中 `language.code` 是否为 `"zh-CN"` 且当前 Wi‑Fi 是否已连接，判断设备是否处于“中文环境”；
    - `IsZhCNForSsid(const std::string& ssid)`：在连接指定 SSID 前，根据 `language.code` 与 `last_ssid` 判断该 SSID 是否应视为中文环境，用于“正在连接 …”阶段提前切换文案语言。
  - 在 `WifiBoard::StartNetwork()` 中：
    - 扫描阶段统一使用英文提示 `Lang::Strings::SCANNING_WIFI`；
    - `OnConnect` 回调：如果即将连接的 SSID 与 `last_ssid` 一致且语言为中文，则提示“正在连接 <SSID>…”，否则使用英文 “Connecting to <SSID>…”；
    - `OnConnected` 回调：根据 `LanguageRuntime::IsZhCN()` 显示“已连接到 <SSID>”或英文 “Connected to <SSID>”；
    - 将 Wi‑Fi 连接等待时间从 **60 秒缩短为 30 秒**，并加注释说明目的：更快进入配置热点模式，方便用户重新配网。
  - 通过 GeoIP 自动检测语言：
    - 以读写模式打开 NVS 命名空间 `language`，读取/写入 `code` 与 `last_ssid`；
    - 在 Wi‑Fi 成功连接后，使用 `http://ip-api.com/json/` 读取 `countryCode`：
      - 若为 `CN`，写入 `language.code = "zh-CN"`；
      - 否则写入 `"en-US"`；
    - 仅在 SSID 改变或之前未记录语言代码时发起 GeoIP 请求，避免每次连网都访问外网；
    - 通过 `printf` 和 `ESP_LOGI/W` 输出详尽调试信息，方便在串口确认语言判定过程。

### 三、UI 文案与激活流程的双语支持

- **涉及文件**：`main/application.cc`、`main/ota.cc`、`main/language_sounds_zh_cn.h`、`main/CMakeLists.txt`
- **修改要点**：
  - **UI 状态栏文案动态切换**：
    - 在 `Application::SetDeviceState()` 等位置使用 `LanguageRuntime::IsZhCN()`，在待机、连接中、聆听中、检查新版本、登录协议等状态下动态选择中文字符串（例如“待机”“正在连接…”“正在检查新版本…”“正在登录…”）或原有英文 `Lang::Strings` 文案。
  - **激活流程显示与语音**：
    - `CheckNewVersion()` 中，当进入激活阶段时，状态栏根据语言环境显示“激活”或英文 “Activation”，同时保持聊天区域内容为服务器下发的 `message`（如 `xiaozhi.me` + 激活码），与旧版本行为一致。
    - `Application::ShowActivationCode()` 中：
      - 新增中英文两套数字语音映射表（0–9），分别使用 `Lang::Sounds` 与 `LangZhCN::Sounds`；
      - 根据 `LanguageRuntime::IsZhCN()` 选择中文或英文的激活提示音 `OGG_ACTIVATION`；
      - 先调用 `Alert()` 播报激活提示，然后逐位播放激活码对应的数字语音，**在中国网络环境下整段提示音和数字为中文，在其他环境下为英文**。
  - **HTTP 头中的语言协商**：
    - 在 `Ota::SetupHttp()` 中新增 `Accept-Language` 头：
      - 优先读取 NVS 中 `language.code`；
      - 若为空则回退到编译时默认 `Lang::CODE`；
      - 使云端服务可以根据设备当前语言环境返回对应语言的对话内容。
  - **音频资源打包**：
    - 在 `main/CMakeLists.txt` 中增加构建逻辑：
      - 将 `main/assets/locales/zh-CN/activation.ogg`、`0.ogg`–`9.ogg` 复制并重命名为 `*_zh.ogg`，一并打包进固件；
      - 新增 `main/language_sounds_zh_cn.h`，暴露 `LangZhCN::Sounds::OGG_ACTIVATION` 及 `OGG_0`–`OGG_9` 的 `std::string_view` 常量，使用 `_binary_*_zh_ogg_start` 符号；
      - 这样在 16MB Flash 下能同时容纳中英文两套关键提示音。

### 四、BOOT 按键恢复启动配网功能

- **涉及文件**：`main/boards/lichuang-c3-dev/lichuang_c3_dev_board.cc`
- **修改要点**：
  - 恢复并简化 BOOT 按键的启动时配网逻辑：
    - 在 `InitializeButtons()` 中为 `boot_button_` 注册 `OnClick` 回调；
    - 当设备处于 `kDeviceStateStarting` 启动阶段时，按下 BOOT 将调用 `ResetWifiConfiguration()`：
      - 将 `wifi` 命名空间中的 `force_ap` 置为 1；
      - 触发重启后直接进入 Wi‑Fi 配置 AP 模式；
    - 若已过启动阶段，则按键用于切换聊天状态（原本交互逻辑保持不变）。

### 五、分区与清理

- **涉及文件**：`partitions/v1/16m.csv`、`sdkconfig`、`partitions/v1/16m_c3.csv`（已删除）
- **修改要点**：
  - 确认当前工程使用的自定义分区表为 `partitions/v1/16m.csv`（`CONFIG_PARTITION_TABLE_CUSTOM_FILENAME`）。
  - 分区布局简要：
    - `nvs` / `otadata` / `phy_init`：用于参数、OTA 信息和 PHY 校准；
    - `model`（spiffs）：用于存放语音模型等数据；
    - `ota_0` / `ota_1`：两个约 7.5MB 的应用槽，支持 OTA 升级。
  - 删除未使用的 `partitions/v1/16m_c3.csv` 以及其他过期分区表，避免后续维护和选择时产生混淆。

### 六、其他调试与可观测性增强

- **涉及文件**：`main/application.cc`
- **修改要点**：
  - 在 `Application::Start()` 中单独提升与唤醒词和对话相关模块的日志级别（如 `"Application"`、`"AudioService"`、`"EspWakeWord"`、`"MQTT"`），方便在不改变全局日志等级的前提下，在串口中稳定看到唤醒、识别和对话关键日志。
  - 在处理唤醒词、语音识别（STT）和语音合成（TTS）等回调处增加 `printf`，确保即使在日志等级较低时，串口仍能看到唤醒词内容、用户说的话以及 TTS 播报文本，便于线上调试和问题追踪。


