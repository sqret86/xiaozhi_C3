# 语言选择功能完成说明

## 完成的工作

### 1. 创建了语言选择配置文件

**文件位置**: `main/language_selection.h`

**功能特点**:
- 支持 38 种语言
- 用户只需取消注释想要的语言即可
- 自动生成对应的 `CONFIG_LANGUAGE_*` 宏定义
- 提供清晰的使用说明和语言列表

**使用方法**:
```cpp
// 简体中文 (Simplified Chinese) - 默认启用
#define SELECTED_LANGUAGE "zh-CN"

// 如需切换到其他语言，注释掉上面的行，取消注释下面对应的语言：
// #define SELECTED_LANGUAGE "en-US"    // 英语
// #define SELECTED_LANGUAGE "ja-JP"    // 日语
// #define SELECTED_LANGUAGE "ko-KR"    // 韩语
// ... 等等
```

### 2. 修改了 CMakeLists.txt

**文件位置**: `main/CMakeLists.txt`

**主要改动**:
- 在编译时自动读取 `language_selection.h` 文件
- 使用正则表达式提取未注释的 `SELECTED_LANGUAGE` 值
- 自动设置 `LANG_DIR` 变量
- 保持与 Kconfig 配置的兼容性（如果 `language_selection.h` 不存在，则回退到 Kconfig）

**工作流程**:
```
编译开始
  ↓
检查 language_selection.h 是否存在？
  ↓ 是
读取文件内容
  ↓
提取未注释的 SELECTED_LANGUAGE
  ↓
设置 LANG_DIR = "zh-CN" (示例)
  ↓
设置 CONFIG_LANGUAGE_ZH_CN = 1
  ↓
收集对应语言的资源文件
  ↓
生成 lang_config.h
  ↓
编译完成
```

### 3. 创建了详细的使用文档

**文件位置**: `main/语言选择说明.md`

**内容包括**:
- 中英文双语说明
- 完整的 38 种语言列表
- 详细的使用方法
- 故障排除指南
- 技术细节说明
- 贡献新语言的指导

## 支持的 38 种语言

1. zh-CN - 简体中文 (Simplified Chinese)
2. zh-TW - 繁体中文 (Traditional Chinese)
3. en-US - 英语 (English)
4. ja-JP - 日语 (Japanese)
5. ko-KR - 韩语 (Korean)
6. fr-FR - 法语 (French)
7. de-DE - 德语 (German)
8. es-ES - 西班牙语 (Spanish)
9. it-IT - 意大利语 (Italian)
10. pt-PT - 葡萄牙语 (Portuguese)
11. ru-RU - 俄语 (Russian)
12. ar-SA - 阿拉伯语 (Arabic)
13. hi-IN - 印地语 (Hindi)
14. th-TH - 泰语 (Thai)
15. vi-VN - 越南语 (Vietnamese)
16. id-ID - 印尼语 (Indonesian)
17. ms-MY - 马来语 (Malay)
18. fil-PH - 菲律宾语 (Filipino)
19. tr-TR - 土耳其语 (Turkish)
20. pl-PL - 波兰语 (Polish)
21. nl-NL - 荷兰语 (Dutch)
22. sv-SE - 瑞典语 (Swedish)
23. nb-NO - 挪威语 (Norwegian)
24. da-DK - 丹麦语 (Danish)
25. fi-FI - 芬兰语 (Finnish)
26. el-GR - 希腊语 (Greek)
27. cs-CZ - 捷克语 (Czech)
28. hu-HU - 匈牙利语 (Hungarian)
29. ro-RO - 罗马尼亚语 (Romanian)
30. bg-BG - 保加利亚语 (Bulgarian)
31. hr-HR - 克罗地亚语 (Croatian)
32. sk-SK - 斯洛伐克语 (Slovak)
33. sl-SI - 斯洛文尼亚语 (Slovenian)
34. sr-RS - 塞尔维亚语 (Serbian)
35. uk-UA - 乌克兰语 (Ukrainian)
36. fa-IR - 波斯语 (Persian)
37. he-IL - 希伯来语 (Hebrew)
38. ca-ES - 加泰罗尼亚语 (Catalan)

## 技术特点

### 1. 简单易用
- 用户只需编辑一个头文件
- 取消注释即可切换语言
- 不需要运行 menuconfig

### 2. 自动化
- CMake 自动读取配置
- 自动生成必要的宏定义
- 自动收集语言资源文件

### 3. 向后兼容
- 如果删除 `language_selection.h`，自动回退到 Kconfig 配置
- 保持原有的编译流程不变

### 4. 后备机制
- 如果某个语言的音频文件缺失
- 自动使用 `en-US` 中的对应文件
- 保证系统正常运行

## 目录结构

```
main/
├── language_selection.h          ← 新增：语言选择配置文件
├── 语言选择说明.md               ← 新增：使用文档
├── assets/
│   ├── common/                   ← 已有：通用音频文件
│   │   ├── exclamation.ogg
│   │   ├── popup.ogg
│   │   ├── success.ogg
│   │   ├── vibration.ogg
│   │   └── low_battery.ogg
│   ├── locales/                  ← 已有：38 种语言资源
│   │   ├── zh-CN/
│   │   ├── en-US/
│   │   └── ... (36 other languages)
│   └── lang_config.h            ← 自动生成
└── CMakeLists.txt               ← 已修改：支持读取 language_selection.h
```

## 使用示例

### 场景1：切换到日语

1. 打开 `main/language_selection.h`
2. 注释掉当前语言：
   ```cpp
   // #define SELECTED_LANGUAGE "zh-CN"
   ```
3. 取消注释日语：
   ```cpp
   #define SELECTED_LANGUAGE "ja-JP"
   ```
4. 编译：
   ```bash
   idf.py build
   idf.py flash
   ```

### 场景2：切换到英语

1. 打开 `main/language_selection.h`
2. 找到英语行：
   ```cpp
   // 英语 (English - US)
   // #define SELECTED_LANGUAGE "en-US"
   ```
3. 删除注释符号 `//`：
   ```cpp
   // 英语 (English - US)
   #define SELECTED_LANGUAGE "en-US"
   ```
4. 确保其他语言都是注释状态
5. 编译并烧录

## 测试建议

### 1. 验证语言切换
```bash
# 清理编译缓存
idf.py fullclean

# 编译
idf.py build

# 检查编译日志中的语言选择信息
# 应该看到类似这样的输出：
# -- Language selected from language_selection.h: zh-CN
```

### 2. 验证音频播放
- 烧录固件后，监听串口输出
- 触发系统提示音
- 确认播放的是所选语言的音频

### 3. 验证后备机制
- 临时删除某个语言的某个 .ogg 文件
- 重新编译
- 确认系统使用 en-US 的对应文件

## 注意事项

1. **同时只能选择一种语言**
   - 确保只有一行 `SELECTED_LANGUAGE` 是未注释的
   - 否则会导致编译错误

2. **需要完全重新编译**
   - 修改语言后建议运行 `idf.py fullclean`
   - 然后再运行 `idf.py build`

3. **正则表达式匹配**
   - CMake 使用正则表达式查找未注释的定义
   - 确保 `#define` 前面没有 `//` 注释符号

4. **文件编码**
   - `language_selection.h` 应使用 UTF-8 编码
   - 确保中文注释能正确显示

## 优势总结

✅ **用户友好**: 只需编辑一个配置文件，无需深入了解构建系统

✅ **清晰直观**: 所有 38 种语言一目了然，每种语言都有中英文说明

✅ **自动化程度高**: CMake 自动处理所有细节

✅ **向后兼容**: 不影响使用 Kconfig 的用户

✅ **易于维护**: 新增语言只需在一个地方添加

✅ **文档完善**: 提供详细的中英文使用说明

## 下一步

现在用户可以：

1. 直接编辑 `main/language_selection.h` 选择语言
2. 查看 `main/语言选择说明.md` 了解详细使用方法
3. 编译并测试不同语言

---

**创建时间**: 2024-11-12  
**项目版本**: 2.0.4  
**作者**: Xiaozhi Project Team

